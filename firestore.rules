/**
 * @file Firebase Security Rules for iBarangay System (Multi-Barangay)
 * @description This ruleset enforces a user-ownership model for residents and their document requests,
 *               with multi-barangay support. Users can only access data from their assigned barangay,
 *               unless they are super admins.
 *
 * Data Structure:
 * - /users/{userId}: Stores user accounts with 'role' and 'barangayId' fields.
 * - /residents/{residentId}: Stores resident profiles, scoped by barangayId.
 * - /documentRequests/{documentRequestId}: Stores document requests, scoped by barangayId.
 * - /payments/{paymentId}: Stores payment information, scoped by barangayId.
 * - /officials/{officialId}: Stores barangay officials, scoped by barangayId.
 * - /barangays/{barangayId}: Stores barangay configuration and information.
 *
 * Key Security Decisions:
 * - All data is scoped by barangayId for multi-tenancy.
 * - Users can only access data from their assigned barangay.
 * - Super admins (isSuperAdmin == true) can access all barangays.
 * - Residents can only read/write their own data within their barangay.
 * - Staff can manage data within their assigned barangay.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) 
        ? get(/databases/$(database)/documents/users/$(uid)).data 
        : null;
    }

    function getUserRole(uid) {
      let userData = getUserData(uid);
      return userData != null ? userData.role : "";
    }

    function getUserBarangayId(uid) {
      let userData = getUserData(uid);
      return userData != null ? userData.barangayId : "";
    }

    function isSuperAdmin() {
      let userData = getUserData(request.auth.uid);
      return isSignedIn() && userData != null && userData.isSuperAdmin == true;
    }

    /**
     * @description Checks if the authenticated user has the "Admin" role.
     */
    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == "Admin";
    }

    /**
     * @description Checks if the authenticated user is a staff member (not a "Resident").
     */
    function isStaff() {
      let role = getUserRole(request.auth.uid);
      return isSignedIn() && role != "Resident" && role != "";
    }

    /**
     * @description Checks if the authenticated user is a Treasurer.
     */
    function isTreasurer() {
      return isSignedIn() && getUserRole(request.auth.uid) == "Treasurer";
    }

    /**
     * @description Checks if the resource belongs to the user's barangay or if user is super admin.
     */
    function isSameBarangay(resourceBarangayId) {
      return isSuperAdmin() || getUserBarangayId(request.auth.uid) == resourceBarangayId;
    }

    /**
     * @description Checks if the incoming data has the correct barangayId.
     */
    function hasValidBarangayId() {
      return isSuperAdmin() || 
        (request.resource.data.barangayId == getUserBarangayId(request.auth.uid));
    }
    
    /**
     * @description Rules for the /barangays/{barangayId} collection.
     */
    match /barangays/{barangayId} {
      // Allow anyone to read active barangays (for registration page)
      allow get: if true;
      // Allow listing active barangays for registration
      allow list: if true;
      allow create: if true; // Allow creation during initial setup
      // Allow Admin and Treasurer to update their barangay
      allow update: if isSuperAdmin() || 
                       ((isAdmin() || isTreasurer()) && isSameBarangay(barangayId));
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for the /users/{userId} collection.
     */
    match /users/{userId} {
      // Allow any authenticated user to read their own document
      allow get: if isSignedIn();
      // Allow staff to list users, but also allow any user to read their own doc for role checking
      allow list: if isSignedIn();
      allow create: if true; 
      allow update: if isSuperAdmin() || isAdmin() || isOwner(userId);
      allow delete: if isSuperAdmin() || isAdmin() || isOwner(userId);
    }

    /**
     * @description Rules for the /residents/{residentId} collection.
     */
    match /residents/{residentId} {
      // Allow get if staff in same barangay or owner
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        (isStaff() && isSameBarangay(resource.data.barangayId)) || 
        isOwner(residentId)
      );
      
      // Allow staff to list residents (query must filter by barangayId in the app)
      // isStaff() already excludes residents (role != "Resident")
      allow list: if isSuperAdmin() || isStaff();
      
      // Allow creation during registration (authenticated users creating their own profile)
      allow create: if (isSignedIn() && hasValidBarangayId()) || 
                       (request.auth != null && request.resource.data.userId == request.auth.uid);
      
      // Allow staff to update residents in their barangay, or residents to update themselves
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        (isStaff() && isSameBarangay(resource.data.barangayId)) || 
        isOwner(residentId)
      );
      
      // Allow staff to delete residents in their barangay
      allow delete: if isSuperAdmin() || (isStaff() && isSameBarangay(resource.data.barangayId));
    }

    /**
     * @description Rules for the /documentRequests/{documentRequestId} collection.
     */
    match /documentRequests/{documentRequestId} {
      // Allow authenticated users to list requests
      // Staff will query by barangayId, residents will query by residentId
      allow list: if isSignedIn();
      
      // Allow get if staff in same barangay or resident owns the request
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        (isStaff() && isSameBarangay(resource.data.barangayId)) || 
        (resource.data.residentId == request.auth.uid)
      );
      
      // Allow residents to create their own requests, or staff to create requests
      allow create: if isSignedIn() && (
        request.resource.data.residentId == request.auth.uid ||
        (isStaff() && hasValidBarangayId())
      );
      
      // Allow staff to update requests in their barangay, or residents to update their own
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        (isStaff() && isSameBarangay(resource.data.barangayId)) || 
        (resource.data.residentId == request.auth.uid)
      );
      
      // Allow staff to delete requests in their barangay
      allow delete: if isSuperAdmin() || (isStaff() && isSameBarangay(resource.data.barangayId));
    }

    /**
     * @description Rules for the /payments/{paymentId} collection.
     * Payments are managed by staff within their barangay.
     */
    match /payments/{paymentId} {
      allow read: if isStaff() && isSameBarangay(resource.data.barangayId);
      allow write: if isStaff() && isSameBarangay(resource.data.barangayId) && hasValidBarangayId();
    }

    /**
     * @description Rules for the /officials/{officialId} collection.
     * Admins can manage officials within their barangay.
     */
    match /officials/{officialId} {
      allow read: if isAdmin() && isSameBarangay(resource.data.barangayId);
      allow write: if isAdmin() && isSameBarangay(resource.data.barangayId) && hasValidBarangayId();
    }

    /**
     * @description Rules for the /barangayConfig/{configId} collection (legacy).
     * Kept for backward compatibility. Redirects to /barangays collection.
     */
    match /barangayConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
