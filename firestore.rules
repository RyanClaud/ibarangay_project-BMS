/**
 * @file Firebase Security Rules for iBarangay System
 * @description This ruleset enforces a user-ownership model for residents and their document requests,
 *               while also providing role-based access for barangay officials and administrators using a role field in the user's document.
 *
 * Data Structure:
 * - /users/{userId}: Stores user accounts with a 'role' field.
 * - /residents/{residentId}: Stores resident profiles, with userId for authentication.
 * - /documentRequests/{documentRequestId}: Stores document requests, linked to residents via residentId.
 * - /payments/{paymentId}: Stores payment information for document requests.
 * - /officials/{officialId}: Stores information about barangay officials.
 * - /barangayConfig/{configId}: Stores configuration settings for the barangay.
 *
 * Key Security Decisions:
 * - The user's role is stored in their document at /users/{userId}.
 * - Authenticated users can read their own user document.
 * - Residents can only read/write their own resident profile.
 * - Staff (non-residents) can read all resident profiles.
 * - Residents can only create document requests for themselves and read their own requests.
 * - Staff (non-residents) can read all document requests.
 * - Admins (role == "Admin") have the highest level of privileges.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserRole(uid) {
      let userDoc = get(/databases/$(database)/documents/users/$(uid));
      if (userDoc.data == null) {
        return "";
      }
      return userDoc.data.role;
    }

    /**
     * @description Checks if the authenticated user has the "Admin" role.
     */
    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == "Admin";
    }

    /**
     * @description Checks if the authenticated user is a staff member (not a "Resident").
     */
    function isStaff() {
      let role = getUserRole(request.auth.uid);
      return isSignedIn() && role != "Resident" && role != "";
    }
    
    /**
     * @description Rules for the /users/{userId} collection.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isStaff();
      allow create: if true; 
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin() || isOwner(userId);
    }

    /**
     * @description Rules for the /residents/{residentId} collection.
     */
    match /residents/{residentId} {
      // A resident can get their own profile. Staff can get any profile.
      allow get: if isStaff() || isOwner(residentId);
      // Staff can list all residents. Unauthenticated users can query for a single resident (for login).
      allow list: if isStaff();
      allow create: if true;
      allow update: if isStaff() || isOwner(residentId);
      allow delete: if isStaff();
    }

    /**
     * @description Rules for the /documentRequests/{documentRequestId} collection.
     */
    match /documentRequests/{documentRequestId} {
      // Staff can list all requests. Residents can't (they query with a where clause).
      allow list: if isStaff();
      // Staff can get any request. A resident can get their own.
      allow get: if isStaff() || (resource.data.residentId == request.auth.uid);
      // A resident can only create document requests for themselves.
      allow create: if request.resource.data.residentId == request.auth.uid;
      // Staff can manage any request. A resident can update/delete their own.
      allow write: if isStaff() || (resource.data.residentId == request.auth.uid);
    }

    /**
     * @description Rules for the /payments/{paymentId} collection.
     * Payments are managed by staff.
     */
    match /payments/{paymentId} {
      allow read, write: if isStaff();
    }

    /**
     * @description Rules for the /officials/{officialId} collection.
     * Only Admins can manage officials.
     */
    match /officials/{officialId} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Rules for the /barangayConfig/{configId} collection.
     * Publicly readable, but only writable by Admins.
     */
    match /barangayConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
